<!DOCTYPE html>
<html>
<head>
    <title>RetroVerse Arcade</title>
    <style>
        body{background:#111;color:#fff;font-family:system-ui;margin:0;padding:20px}
        #screen{width:100%;max-width:800px;height:480px;background:#000;margin:0 auto;image-rendering:pixelated}
        .game-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;padding:20px}
        .game-card{background:#222;padding:10px;border-radius:8px;text-align:center;cursor:pointer;transition:transform .2s}
        .game-card:hover{transform:scale(1.05)}
        .game-card img{width:100%;height:150px;object-fit:cover;border-radius:4px}
        #save-indicator{position:fixed;right:20px;top:20px;background:#28a745;padding:10px;border-radius:4px;display:none}
    </style>
</head>
<body>
    <canvas id="screen"></canvas>
    <div id="save-indicator">Progress Saved!</div>
    <div class="game-grid" id="gameList"></div>

    <script>
        const GAMES_DATABASE = {
            nes: [
                {
                    title: "Super Mario Bros",
                    image: "data:image/webp;base64,BASE64_IMAGE_DATA",
                    url: "https://yourcdn.com/roms/mario.nes",
                    size: "32KB"
                },
                {
                    title: "Legend of Zelda",
                    image: "data:image/webp;base64,BASE64_IMAGE_DATA",
                    url: "https://yourcdn.com/roms/zelda.nes",
                    size: "128KB"
                }
            ],
            snes: [
                {
                    title: "Chrono Trigger",
                    image: "data:image/webp;base64,BASE64_IMAGE_DATA",
                    url: "https://yourcdn.com/roms/chrono.sfc",
                    size: "4MB"
                }
            ]
        };

        class SaveManager {
            constructor() {
                this.autoSaveInterval = 5 * 60 * 1000; // 5 minutes
                this.setupAutoSave();
            }

            setupAutoSave() {
                setInterval(() => this.autoSave(), this.autoSaveInterval);
                window.addEventListener('beforeunload', (e) => {
                    this.saveState();
                    e.preventDefault();
                    return e.returnValue = 'Do you want to save your progress?';
                });
            }

            async saveState() {
                const state = await emu.getCurrentState();
                const gameId = emu.currentGame.title;
                localStorage.setItem(`save_${gameId}`, JSON.stringify(state));
                this.showSaveIndicator();
            }

            async loadState(gameId) {
                const savedState = localStorage.getItem(`save_${gameId}`);
                if (savedState) {
                    return JSON.parse(savedState);
                }
                return null;
            }

            autoSave() {
                if (emu.running) {
                    this.saveState();
                }
            }

            showSaveIndicator() {
                const indicator = document.getElementById('save-indicator');
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }

        class ROMLoader {
            constructor() {
                this.cache = new Map();
            }

            async loadGame(gameInfo) {
                if (this.cache.has(gameInfo.url)) {
                    return this.cache.get(gameInfo.url);
                }

                const response = await fetch(gameInfo.url);
                const arrayBuffer = await response.arrayBuffer();
                const romData = new Uint8Array(arrayBuffer);
                
                this.cache.set(gameInfo.url, romData);
                return romData;
            }

            async preloadGames() {
                const priorityGames = Object.values(GAMES_DATABASE)
                    .flat()
                    .slice(0, 3); // Preload first 3 games

                await Promise.all(
                    priorityGames.map(game => 
                        this.loadGame(game)
                            .catch(err => console.log(`Preload failed for ${game.title}`))
                    )
                );
            }
        }

        // Enhanced RetroEmulator with state management
        class RetroEmulator {
            constructor() {
                this.canvas = document.getElementById("screen");
                this.ctx = this.canvas.getContext("2d");
                this.setupGL();
                this.initAudio();
                this.bindControls();
                this.saveManager = new SaveManager();
                this.romLoader = new ROMLoader();
                this.initializeGameList();
            }

            async initializeGameList() {
                const gameList = document.getElementById('gameList');
                Object.entries(GAMES_DATABASE).forEach(([system, games]) => {
                    games.forEach(game => {
                        const card = this.createGameCard(game, system);
                        gameList.appendChild(card);
                    });
                });

                // Start preloading games
                this.romLoader.preloadGames();
            }

            createGameCard(game, system) {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.innerHTML = `
                    <img src="${game.image}" alt="${game.title}">
                    <h3>${game.title}</h3>
                    <p>System: ${system.toUpperCase()}</p>
                    <p>Size: ${game.size}</p>
                `;
                card.onclick = () => this.startGame(game, system);
                return card;
            }

            async startGame(game, system) {
                this.currentGame = game;
                const romData = await this.romLoader.loadGame(game);
                const savedState = await this.saveManager.loadState(game.title);
                
                this.loadROM(romData);
                if (savedState) {
                    this.loadState(savedState);
                }
            }

            async getCurrentState() {
                return {
                    memory: Array.from(this.memory),
                    registers: this.registers,
                    timestamp: Date.now()
                };
            }
        }

        const emu = new RetroEmulator();
    </script>
</body>
</html>
